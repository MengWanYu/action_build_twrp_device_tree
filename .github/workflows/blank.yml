name: 生成TWRP设备树  # 工作流名称

# 触发方式：手动触发（在GitHub仓库的Actions页面手动点击运行）
on:
  workflow_dispatch:
    inputs:
      LIBRARY_NAME:
        description: '设备树的库名称（用于命名最终输出）'  # 输入项说明
        required: true
        default: 'Twrp_Device_vivoy70s'  # 默认设备树名称（对应vivo Y70s）
      IMG_URL:
        description: 'recovery/boot镜像的下载链接'  # 输入项说明
        required: true
        default: 'https://www.ilanzou.com/s/pCuneprp'  # 默认镜像链接（蓝奏云）

jobs:
  generate-device-tree:
    # 仅当仓库所有者手动触发时才运行（防止他人滥用）
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-latest  # 使用最新版Ubuntu服务器运行

    steps:
    # 步骤1：拉取当前仓库的代码（如果仓库里有自定义脚本，这一步会获取）
    - name: 拉取仓库代码
      uses: actions/checkout@v4

    # 步骤2：配置运行环境（安装所需的系统依赖）
    - name: 配置系统环境
      run: |
        # 更新系统软件源
        sudo apt-get update
        # 安装必要工具：Python3、pip（Python包管理器）、cpio（镜像解包工具）、wget（下载工具）等
        sudo apt-get install -y \
          python3 \
          python3-pip \
          cpio \
          wget \
          zip \
          unzip \
          abootimg \  # 处理boot/recovery镜像的工具
          python3-magic  # twrpdtgen依赖的文件类型识别库

    # 步骤3：克隆官方AIK工具（解决自动克隆AIK失败的问题）
    - name: 克隆Android Image Kitchen（AIK）
      run: |
        # 从官方仓库克隆AIK到本地目录，后续生成设备树会直接用这个本地版本
        git clone https://github.com/osm0sis/Android-Image-Kitchen.git ~/local_aik
        
    # 步骤4：安装TWRP设备树生成工具（twrpdtgen）
    - name: 从fork仓库安装自定义twrpdtgen
      run: |
        # 克隆你fork的twrpdtgen仓库（master分支）
        git clone -b master https://github.com/MengWanYu/twrpdtgen.git ~/twrpdtgen_fork
        # 进入仓库目录，本地安装（优先使用你修改后的代码）
        cd ~/twrpdtgen_fork
        pip3 install .
       
    # 步骤5：下载recovery镜像（从你提供的链接下载）
    - name: 下载recovery镜像
      run: |
        # 下载镜像并命名为recovery.img（--content-disposition处理蓝奏云的跳转下载）
        wget --content-disposition -O recovery.img "${{ github.event.inputs.IMG_URL }}"
        # 打印文件信息，用于调试（如果下载失败，能看到文件类型是否正确）
        file recovery.img || true

    # 步骤6：生成TWRP设备树（核心步骤）
    - name: 生成设备树文件
      run: |
        # 创建输出目录
        mkdir -p device_tree_output
        # 运行twrpdtgen生成设备树：
        # -o 指定输出目录
        # --aik-path 指定本地AIK路径（避免自动克隆失败）
        python3 -m twrpdtgen \
          -o device_tree_output \
          --aik-path ~/local_aik \  # 关键：使用步骤3克隆的本地AIK
          recovery.img

    # 步骤7：压缩生成的设备树（方便后续发布下载）
    - name: 压缩设备树文件
      run: |
        # 进入输出目录，将设备树打包成zip（用用户输入的LIBRARY_NAME命名压缩包）
        cd device_tree_output
        zip -r ../${{ github.event.inputs.LIBRARY_NAME }}_${{ github.run_number }}.zip .
        cd ..

    # 步骤8：创建GitHub Release并上传设备树压缩包
    - name: 发布设备树压缩包
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ github.event.inputs.LIBRARY_NAME }}_${{ github.run_number }}.zip  # 要上传的压缩包
        name: ${{ github.event.inputs.LIBRARY_NAME }}_第${{ github.run_number }}次构建  # Release名称
        tag_name: dt-${{ github.run_number }}  # Release标签（用于区分版本）
        body: |  # Release描述
          自动生成的TWRP设备树
          构建次数：${{ github.run_number }}
          镜像来源：${{ github.event.inputs.IMG_URL }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub自动提供的令牌，用于发布Release
