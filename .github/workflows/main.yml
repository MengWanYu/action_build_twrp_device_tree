# 工作流触发条件（需在文件顶部）
on:
  workflow_dispatch:
    inputs:
      TARGET_REPO_NAME:
        description: '目标仓库名称'
        required: true
        default: 'twrp-device-tree'
      ZIP_DOWNLOAD_URL:
        description: '设备树压缩包直链'
        required: true
        default: 'https://xxx.zip'
      IS_PRIVATE_REPO:
        description: '是否私有仓库'
        required: true
        default: 'false'

# 任务定义
jobs:
  push-device-tree-to-repo:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-latest
    steps:
      # （其他步骤：如配置环境、下载压缩包、解压等，需放在此处）

      # 本步骤：推送到目标仓库（正确嵌套在steps序列中）
      - name: 推送到执行者的GitHub仓库（最终修复版）
        # run字段需缩进（相对于步骤的“-”）
        run: |
          # 1. 配置Git身份和默认分支
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global init.defaultBranch main

          # 2. 初始化仓库并提交代码
          cd extracted_device_tree
          git init
          git add .
          git commit -m "Auto-pushed TWRP device tree from zip: ${{ github.event.inputs.ZIP_DOWNLOAD_URL }}"

          # 3. 拼接目标仓库地址
          TARGET_REPO="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.actor }}/${{ github.event.inputs.TARGET_REPO_NAME }}.git"
          echo "目标仓库地址：$TARGET_REPO"

          # 4. 创建目标仓库（动态选择公开/私有）
          echo "正在创建目标仓库（私有：${{ github.event.inputs.IS_PRIVATE_REPO }}）..."
          if [ "${{ github.event.inputs.IS_PRIVATE_REPO }}" = "true" ]; then
            # 私有仓库
            gh repo create ${{ github.actor }}/${{ github.event.inputs.TARGET_REPO_NAME }} \
              --private \
              --description "TWRP device tree (auto-pushed from zip)"
          else
            # 公开仓库
            gh repo create ${{ github.actor }}/${{ github.event.inputs.TARGET_REPO_NAME }} \
              --public \
              --description "TWRP device tree (auto-pushed from zip)"
          fi

          # 5. 推送代码
          echo "正在推送代码到目标仓库..."
          git remote add origin $TARGET_REPO
          git push -u origin main -f

          echo "✅ 设备树已成功推送到仓库：https://github.com/${{ github.actor }}/${{ github.event.inputs.TARGET_REPO_NAME }}"
        # env字段与run同级缩进（相对于步骤的“-”）
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
