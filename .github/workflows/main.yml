name: 下载设备树压缩包并推送到仓库
on:
  workflow_dispatch:
    inputs:
      # 让执行者填写：目标仓库名称（要新建/推送的仓库）
      TARGET_REPO_NAME:
        description: '目标仓库名称（如：twrp-device-xiaomi-mi10）'
        required: true
        default: 'twrp-device-tree'
      # 让执行者填写：设备树压缩包的公开直链
      ZIP_DOWNLOAD_URL:
        description: '设备树压缩包的公开下载直链（.zip格式）'
        required: true
        default: 'https://github.com/xxx/xxx/releases/download/v1/DeviceTree.zip'
      # 可选：目标仓库是否私有（默认公开）
      IS_PRIVATE_REPO:
        description: '目标仓库是否私有？（true/false）'
        required: true
        default: 'false'

jobs:
  push-device-tree-to-repo:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-latest
    steps:
      # 步骤1：配置基础环境（安装必要工具）
      - name: 配置基础环境
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip git

      # 步骤2：下载设备树压缩包
      - name: 下载设备树压缩包
        run: |
          # 下载压缩包到当前目录，命名为device_tree.zip
          wget -O device_tree.zip "${{ github.event.inputs.ZIP_DOWNLOAD_URL }}"
          # 验证压缩包是否有效（避免下载失败）
          if [ ! -f "device_tree.zip" ] || [ $(stat -c%s "device_tree.zip") -lt 1024 ]; then
            echo "错误：压缩包下载失败或文件无效"
            exit 1
          fi
          echo "压缩包下载成功，大小：$(stat -c%s "device_tree.zip") 字节"

      # 步骤3：解压压缩包
      - name: 解压设备树压缩包
        run: |
          # 创建解压目录并解压
          mkdir -p extracted_device_tree
          unzip -q device_tree.zip -d extracted_device_tree/
          # 进入解压目录，确保有设备树文件（避免空压缩包）
          cd extracted_device_tree
          if [ $(ls -l | wc -l) -lt 2 ]; then
            echo "错误：压缩包解压后无有效文件"
            exit 1
          fi
          echo "压缩包解压成功，包含文件：$(ls -l | wc -l) 个"

      # 步骤4：配置Git并推送到目标仓库
      - name: 推送到执行者的GitHub仓库
        run: |
          # 1. 配置Git身份（用于提交代码）
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # 2. 进入解压后的设备树目录，初始化Git仓库
          cd extracted_device_tree
          git init
          git add .
          git commit -m "Auto-pushed device tree from zip: ${{ github.event.inputs.ZIP_DOWNLOAD_URL }}"

          # 3. 拼接目标仓库的远程地址（用GitHub Token授权）
          TARGET_REPO="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.actor }}/${{ github.event.inputs.TARGET_REPO_NAME }}.git"

          # 4. 创建目标仓库（借助GitHub CLI，自动安装）
          sudo apt install -y gh
          gh repo create ${{ github.actor }}/${{ github.event.inputs.TARGET_REPO_NAME }} \
            --private=${{ github.event.inputs.IS_PRIVATE_REPO }} \
            --description "TWRP device tree (auto-pushed from zip)"

          # 5. 推送代码到目标仓库（强制推送，覆盖现有仓库内容）
          git remote add origin $TARGET_REPO
          git push -u origin main -f

          echo "✅ 设备树已成功推送到仓库：https://github.com/${{ github.actor }}/${{ github.event.inputs.TARGET_REPO_NAME }}"
        env:
          # 授权GitHub CLI操作仓库
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

