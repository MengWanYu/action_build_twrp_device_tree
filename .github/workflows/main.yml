name: 下载设备树压缩包并推送到仓库
on:
  workflow_dispatch:
    inputs:
      # 运行前可修改的目标仓库名称（默认：android_device_tree_vivoy70s）
      TARGET_REPO_NAME:
        description: '目标仓库名称'
        required: true
        default: 'android_device_tree_vivoy70s'
      # 运行前可修改的压缩包直链（默认你提供的链接）
      ZIP_DOWNLOAD_URL:
        description: '设备树压缩包公开直链'
        required: true
        default: 'https://release-assets.githubusercontent.com/github-production-release-asset/1146639405/3d1862b6-d057-431a-9476-39603885f5b9?sp=r&sv=2018-11-09&sr=b&spr=https&se=2026-01-31T15%3A14%3A56Z&rscd=attachment%3B+filename%3DTwrp_Device_vivoy70s_11.zip&rsct=application%2Foctet-stream&skoid=96c2d410-5711-43a1-aedd-ab1947aa7ab0&sktid=398a6654-997b-47e9-b12b-9515b896b4de&skt=2026-01-31T14%3A14%3A39Z&ske=2026-01-31T15%3A14%3A56Z&sks=b&skv=2018-11-09&sig=4jcObW9Hhv1qKjIUbGxZcqVgmomeoBrxFteynbfIe0c%3D&jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmVsZWFzZS1hc3NldHMuZ2l0aHVidXNlcmNvbnRlbnQuY29tIiwia2V5Ijoia2V5MSIsImV4cCI6MTc2OTg3MDc3NywibmJmIjoxNzY5ODY4OTc3LCJwYXRoIjoicmVsZWFzZWFzc2V0cHJvZHVjdGlvbi5ibG9iLmNvcmUud2luZG93cy5uZXQifQ.uB-5baXgjQkhEQ2VWtCi68U07m2rMpYXbzQFqG1saUE&response-content-disposition=attachment%3B%20filename%3DTwrp_Device_vivoy70s_11.zip&response-content-type=application%2Foctet-stream'
      # 仓库是否私有（默认公开）
      IS_PRIVATE_REPO:
        description: '目标仓库是否私有？（true/false）'
        required: true
        default: 'false'

jobs:
  push-device-tree:
    # 仅允许仓库所有者触发
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-latest
    steps:
      # 步骤1：配置基础环境（安装工具）
      - name: 配置基础环境
        run: |
          sudo apt-get update
          # 安装必要工具：wget（下载）、unzip（解压）、git（版本控制）
          sudo apt-get install -y wget unzip git
          # 安装GitHub CLI（用于创建仓库）
          type -p curl >/dev/null || sudo apt install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      # 步骤2：下载设备树压缩包
      - name: 下载设备树压缩包
        run: |
          # 下载压缩包到当前目录（命名为device_tree.zip）
          wget -O device_tree.zip "${{ github.event.inputs.ZIP_DOWNLOAD_URL }}"
          # 验证压缩包有效性（大小≥1MB）
          if [ ! -f "device_tree.zip" ] || [ $(stat -c%s "device_tree.zip") -lt 1048576 ]; then
            echo "错误：压缩包下载失败或文件无效"
            exit 1
          fi
          echo "压缩包下载成功，大小：$(stat -c%s "device_tree.zip") 字节"

      # 步骤3：解压设备树压缩包
      - name: 解压设备树压缩包
        run: |
          # 创建解压目录
          mkdir -p extracted_device_tree
          # 解压到指定目录
          unzip -q device_tree.zip -d extracted_device_tree/
          # 验证解压结果（至少有1个文件）
          cd extracted_device_tree
          if [ $(ls -l | wc -l) -lt 2 ]; then
            echo "错误：压缩包解压后无有效文件"
            exit 1
          fi
          echo "压缩包解压成功，包含文件：$(ls | wc -l) 个"

      # 步骤4：推送到执行者的GitHub仓库
      - name: 推送到目标仓库
        run: |
          # 1. 配置Git身份（用于提交代码）
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global init.defaultBranch main

          # 2. 初始化仓库并提交代码
          cd extracted_device_tree
          git init
          git add .
          git commit -m "Auto-pushed TWRP device tree (source: ${{ github.event.inputs.ZIP_DOWNLOAD_URL }})"

          # 3. 拼接目标仓库地址（用Token授权）
          TARGET_REPO="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.actor }}/${{ github.event.inputs.TARGET_REPO_NAME }}.git"
          echo "目标仓库地址：$TARGET_REPO"

          # 4. 创建目标仓库（根据输入选择公开/私有）
          echo "正在创建仓库：${{ github.actor }}/${{ github.event.inputs.TARGET_REPO_NAME }}"
          if [ "${{ github.event.inputs.IS_PRIVATE_REPO }}" = "true" ]; then
            gh repo create ${{ github.actor }}/${{ github.event.inputs.TARGET_REPO_NAME }} --private --description "TWRP device tree for vivo Y70s"
          else
            gh repo create ${{ github.actor }}/${{ github.event.inputs.TARGET_REPO_NAME }} --public --description "TWRP device tree for vivo Y70s"
          fi

          # 5. 推送代码到目标仓库
          git remote add origin $TARGET_REPO
          git push -u origin main -f

          echo "✅ 设备树已成功推送到仓库：https://github.com/${{ github.actor }}/${{ github.event.inputs.TARGET_REPO_NAME }}"
        env:
          # 授权GitHub CLI和Git操作
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
